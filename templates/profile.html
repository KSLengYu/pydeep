{% extends "base.html" %}

{% block title %}ä¸ªäººä¸­å¿ƒ - ç§‘å¹»ç•™è¨€æ¿{% endblock %}

{% block content %}
<div class="content" style="max-width: 800px; margin: 0 auto;">
    <div class="main-content">
        <h2 style="color: var(--primary); margin-bottom: 20px; text-align: center;">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</h2>
        
        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div style="background: rgba(0,255,255,0.2); padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 1px solid var(--primary);">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(45deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-right: 20px;">
                    ğŸ‘½
                </div>
                <div>
                    <h3 style="color: var(--text); margin-bottom: 5px;">
                        {{ user.email }}
                        {% if user.role in ['admin', 'super_admin'] %}
                        <span class="verified-badge" title="ç®¡ç†å‘˜">âœ“</span>
                        {% endif %}
                    </h3>
                    <p style="color: var(--light);">
                        {% if user.qq_nickname %}
                            QQæ˜µç§°: {{ user.qq_nickname }}
                        {% else %}
                            æœªç»‘å®šQQ
                        {% endif %}
                    </p>
                    <p style="color: var(--light); font-size: 14px;">
                        æ³¨å†Œæ—¶é—´: {{ user.created_at[:10] }}
                    </p>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="color: var(--primary); font-size: 1.5rem; font-weight: bold;">{{ user.role|title }}</div>
                    <div style="color: var(--light); font-size: 14px;">è´¦æˆ·ç±»å‹</div>
                </div>
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="color: var(--secondary); font-size: 1.5rem; font-weight: bold;">
                        {% if user.is_verified %}å·²éªŒè¯{% else %}æœªéªŒè¯{% endif %}
                    </div>
                    <div style="color: var(--light); font-size: 14px;">é‚®ç®±çŠ¶æ€</div>
                </div>
            </div>
        </div>

        <!-- QQç»‘å®šè®¾ç½® -->
        <div style="background: rgba(255,0,255,0.2); padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 1px solid var(--secondary);">
            <h3 style="color: var(--secondary); margin-bottom: 20px;">ğŸ“± QQè´¦å·ç»‘å®š</h3>
            
            <form id="qqForm">
                <div class="form-group">
                    <label style="color: var(--light); margin-bottom: 5px; display: block;">QQå·ç </label>
                    <input type="text" id="qqNumber" class="form-control" placeholder="è¯·è¾“å…¥QQå·ç " value="{{ user.qq_number or '' }}">
                </div>
                
                <div class="form-group">
                    <label style="color: var(--light); margin-bottom: 5px; display: block;">QQæ˜µç§°</label>
                    <input type="text" id="qqNickname" class="form-control" placeholder="è¯·è¾“å…¥QQæ˜µç§°" value="{{ user.qq_nickname or '' }}">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn" style="flex: 1;">ä¿å­˜QQä¿¡æ¯</button>
                    {% if user.qq_number %}
                    <button type="button" onclick="unbindQQ()" class="btn" style="background: #ff4444; flex: 1;">è§£ç»‘QQ</button>
                    {% endif %}
                </div>
            </form>
            
            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                <p style="color: var(--light); font-size: 14px; margin: 0;">
                    ğŸ’¡ ç»‘å®šQQåï¼Œæ‚¨çš„ç•™è¨€å°†æ˜¾ç¤ºQQæ˜µç§°è€Œä¸æ˜¯é‚®ç®±åœ°å€ï¼Œä¿æŠ¤éšç§ã€‚
                </p>
            </div>
        </div>

        <!-- å¯†ç ä¿®æ”¹ -->
        <div style="background: rgba(0,255,0,0.2); padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 1px solid var(--accent);">
            <h3 style="color: var(--accent); margin-bottom: 20px;">ğŸ”’ ä¿®æ”¹å¯†ç </h3>
            
            <form id="passwordForm">
                <div class="form-group">
                    <label style="color: var(--light); margin-bottom: 5px; display: block;">å½“å‰å¯†ç </label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required>
                </div>
                
                <div class="form-group">
                    <label style="color: var(--light); margin-bottom: 5px; display: block;">æ–°å¯†ç </label>
                    <input type="password" id="newPassword" class="form-control" placeholder="è¯·è¾“å…¥æ–°å¯†ç " required minlength="6">
                </div>
                
                <div class="form-group">
                    <label style="color: var(--light); margin-bottom: 5px; display: block;">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required minlength="6">
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">ä¿®æ”¹å¯†ç </button>
            </form>
            
            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                <p style="color: var(--light); font-size: 14px; margin: 0;">
                    ğŸ’¡ å¯†ç é•¿åº¦è‡³å°‘6ä½ï¼Œå»ºè®®ä½¿ç”¨å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šç¬¦å·ç»„åˆã€‚
                </p>
            </div>
        </div>

        <!-- è´¦æˆ·å®‰å…¨ -->
        <div style="background: rgba(255,255,0,0.2); padding: 25px; border-radius: 10px; border: 1px solid #ffcc00;">
            <h3 style="color: #ffcc00; margin-bottom: 15px;">âš ï¸ è´¦æˆ·å®‰å…¨</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="color: {% if user.is_verified %}var(--accent){% else %}#ff4444{% endif %}; font-size: 1.2rem; margin-bottom: 5px;">
                        {% if user.is_verified %}âœ…{% else %}âŒ{% endif %}
                    </div>
                    <div style="color: var(--light); font-size: 14px;">é‚®ç®±éªŒè¯</div>
                </div>
                
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="color: {% if user.qq_number %}var(--accent){% else %}#ff4444{% endif %}; font-size: 1.2rem; margin-bottom: 5px;">
                        {% if user.qq_number %}âœ…{% else %}âŒ{% endif %}
                    </div>
                    <div style="color: var(--light); font-size: 14px;">QQç»‘å®š</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: var(--light); font-size: 14px;">
                    æœ€åæ›´æ–°: {{ user.updated_at[:16].replace('T', ' ') if user.updated_at else 'æœªçŸ¥' }}
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ä¿å­˜QQä¿¡æ¯
    document.getElementById('qqForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const qqNumber = document.getElementById('qqNumber').value.trim();
        const qqNickname = document.getElementById('qqNickname').value.trim();
        
        if (!qqNumber && !qqNickname) {
            showAlert('è¯·å¡«å†™QQå·ç æˆ–æ˜µç§°', 'error');
            return;
        }
        
        fetch('/update_profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                qq_number: qqNumber,
                qq_nickname: qqNickname
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('QQä¿¡æ¯ä¿å­˜æˆåŠŸ', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    });
    
    // è§£ç»‘QQ
    function unbindQQ() {
        if (!confirm('ç¡®å®šè¦è§£ç»‘QQå—ï¼Ÿè§£ç»‘åç•™è¨€å°†æ˜¾ç¤ºé‚®ç®±åœ°å€ã€‚')) {
            return;
        }
        
        fetch('/update_profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                qq_number: '',
                qq_nickname: ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('QQè§£ç»‘æˆåŠŸ', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('è§£ç»‘å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    
    // ä¿®æ”¹å¯†ç 
    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            showAlert('è¯·å¡«å†™å®Œæ•´çš„å¯†ç ä¿¡æ¯', 'error');
            return;
        }
        
        if (newPassword.length < 6) {
            showAlert('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showAlert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
            return;
        }
        
        if (newPassword === currentPassword) {
            showAlert('æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ', 'error');
            return;
        }
        
        fetch('/change_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                current_password: currentPassword,
                new_password: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', 'success');
                setTimeout(() => {
                    window.location.href = '/logout';
                }, 2000);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    });
    
    // è¾“å…¥éªŒè¯
    document.getElementById('qqNumber').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^\d]/g, '');
    });
</script>
{% endblock %}