{% extends "base.html" %}

{% block title %}é¦–é¡µ - ç§‘å¹»ç•™è¨€æ¿{% endblock %}

{% block content %}
<div class="content">
    <div class="main-content">
        <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ’¬ æœ€æ–°ç•™è¨€</h2>
        
        <!-- å‘å¸ƒç•™è¨€åŒºåŸŸ -->
        <div class="message-form" style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid var(--accent);">
            <form id="messageForm">
                <div class="form-group">
                    <textarea id="messageContent" class="form-control" rows="4" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." required></textarea>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: var(--light); font-size: 14px;">
                        {% if user %}
                            <span>ç™»å½•ç”¨æˆ·</span>
                        {% else %}
                            <span>æ¸¸å®¢æ¨¡å¼ (ä»Šæ—¥å‰©ä½™: <span id="guestRemaining">5</span> æ¡)</span>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn">å‘å¸ƒç•™è¨€</button>
                </div>
            </form>
        </div>
        
        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div id="messagesList">
            {% for message in messages %}
            <div class="message-item" style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); position: relative;">
                <!-- ç®¡ç†å‘˜è®¤è¯å¾½ç«  -->
                {% if message.users and message.users.role in ['admin', 'super_admin'] %}
                <div class="verified-badge" title="ç®¡ç†å‘˜" style="position: absolute; top: 15px; right: 15px;">âœ“</div>
                {% endif %}
                
                <!-- ç•™è¨€å†…å®¹ -->
                <div class="message-content" style="margin-bottom: 15px;">
                    <p style="font-size: 16px; line-height: 1.6;">{{ message.content }}</p>
                </div>
                
                <!-- ç•™è¨€ä¿¡æ¯ -->
                <div class="message-meta" style="display: flex; justify-content: space-between; font-size: 12px; color: var(--light); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                    <div>
                        {% if message.users %}
                            {% if message.users.qq_nickname %}
                                <span>{{ message.users.qq_nickname }}</span>
                            {% else %}
                                <span>{{ message.users.email }}</span>
                            {% endif %}
                        {% else %}
                            <span>æ¸¸å®¢</span>
                        {% endif %}
                        â€¢ 
                        <span>{{ message.location }}</span> â€¢ 
                        <span>{{ message.device_info }}</span>
                    </div>
                    <div>
                        <span>{{ message.created_at[:16].replace('T', ' ') }}</span>
                        {% if user and user.role in ['admin', 'super_admin'] %}
                        <button class="btn-delete" onclick="deleteMessage('{{ message.id }}')" style="background: #ff4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; margin-left: 10px; font-size: 12px; cursor: pointer;">åˆ é™¤</button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- å›å¤åŒºåŸŸ -->
                <div class="message-actions" style="margin-top: 10px;">
                    <button class="btn-reply" onclick="toggleReplyForm('{{ message.id }}')" style="background: transparent; color: var(--light); border: 1px solid var(--light); padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer;">å›å¤</button>
                    
                    {% if message.is_folded %}
                    <button class="btn-fold" onclick="toggleFold('{{ message.id }}')" style="background: transparent; color: var(--accent); border: 1px solid var(--accent); padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer; margin-left: 10px;">å±•å¼€</button>
                    {% else %}
                    <button class="btn-fold" onclick="toggleFold('{{ message.id }}')" style="background: transparent; color: var(--accent); border: 1px solid var(--accent); padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer; margin-left: 10px;">æŠ˜å </button>
                    {% endif %}
                </div>
                
                <!-- å›å¤è¡¨å• -->
                <div id="replyForm-{{ message.id }}" class="reply-form" style="display: none; margin-top: 15px;">
                    <form onsubmit="postReply(event, '{{ message.id }}')">
                        <div class="form-group">
                            <textarea class="form-control" rows="2" placeholder="å†™ä¸‹ä½ çš„å›å¤..." required></textarea>
                        </div>
                        <div style="text-align: right;">
                            <button type="button" onclick="toggleReplyForm('{{ message.id }}')" style="background: transparent; color: var(--light); border: 1px solid var(--light); padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer; margin-right: 10px;">å–æ¶ˆ</button>
                            <button type="submit" style="background: var(--accent); color: var(--dark); border: none; padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer;">å›å¤</button>
                        </div>
                    </form>
                </div>
                
                <!-- å›å¤åˆ—è¡¨ -->
                <div id="replies-{{ message.id }}" class="replies" style="margin-top: 15px; padding-left: 20px; border-left: 2px solid var(--secondary);">
                    <!-- å›å¤å†…å®¹å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: var(--light);">
                <p>æš‚æ— ç•™è¨€ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªå‘è¨€çš„äººå§ï¼</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="sidebar">
        <h3 style="color: var(--secondary); margin-bottom: 15px;">ğŸ“‹ æ›´æ–°æ—¥å¿—</h3>
        <div class="update-logs">
            {% for log in update_logs %}
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid var(--secondary);">
                <h4 style="color: var(--primary); margin-bottom: 5px;">{{ log.title }}</h4>
                <p style="color: var(--light); font-size: 14px; margin-bottom: 5px;">{{ log.content }}</p>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--light);">
                    <span>{{ log.version }}</span>
                    <span>{{ log.created_at[:10] }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div style="margin-top: 30px;">
            <h3 style="color: var(--secondary); margin-bottom: 15px;">â„¹ï¸ ä½¿ç”¨è¯´æ˜</h3>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                <ul style="color: var(--light); font-size: 14px; padding-left: 20px;">
                    <li>æ¸¸å®¢æ¯æ—¥å¯å‘å¸ƒ5æ¡ç•™è¨€</li>
                    <li>æ³¨å†Œç”¨æˆ·æ— é™åˆ¶ï¼Œæ”¯æŒQQç»‘å®š</li>
                    <li>ç®¡ç†å‘˜æœ‰è“è‰²è®¤è¯å¾½ç« </li>
                    <li>æ”¯æŒç•™è¨€å›å¤å’ŒæŠ˜å åŠŸèƒ½</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // å‘å¸ƒç•™è¨€
    document.getElementById('messageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = document.getElementById('messageContent').value.trim();
        
        if (!content) {
            showAlert('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'error');
            return;
        }
        
        fetch('/post_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('messageContent').value = '';
                showAlert(data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'error');
                if (data.message.includes('æ¸¸å®¢æ¯æ—¥åªèƒ½å‘å¸ƒ5æ¡')) {
                    document.getElementById('guestRemaining').textContent = '0';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    });
    
    // åˆ‡æ¢å›å¤è¡¨å•æ˜¾ç¤º
    function toggleReplyForm(messageId) {
        const form = document.getElementById(`replyForm-${messageId}`);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }
    
    // å‘å¸ƒå›å¤
    function postReply(event, parentId) {
        event.preventDefault();
        const content = event.target.querySelector('textarea').value.trim();
        
        if (!content) {
            showAlert('è¯·è¾“å…¥å›å¤å†…å®¹', 'error');
            return;
        }
        
        fetch('/post_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                content: content,
                parent_id: parentId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                event.target.querySelector('textarea').value = '';
                showAlert(data.message, 'success');
                toggleReplyForm(parentId);
                loadReplies(parentId);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('å›å¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    
    // åŠ è½½å›å¤
    function loadReplies(messageId) {
        fetch(`/get_replies/${messageId}`)
        .then(response => response.json())
        .then(replies => {
            const container = document.getElementById(`replies-${messageId}`);
            container.innerHTML = '';
            
            if (replies.length === 0) return;
            
            replies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'reply-item';
                replyElement.style.cssText = 'background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;';
                
                let userDisplay = 'æ¸¸å®¢';
                if (reply.users) {
                    userDisplay = reply.users.qq_nickname || reply.users.email;
                }
                
                replyElement.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <p style="font-size: 14px; line-height: 1.5;">${reply.content}</p>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--light);">
                        <div>
                            <span>${userDisplay}</span> â€¢ 
                            <span>${reply.location}</span>
                        </div>
                        <div>
                            <span>${reply.created_at ? reply.created_at.slice(0, 16).replace('T', ' ') : ''}</span>
                            ${'{% if user and user.role in ["admin", "super_admin"] %}'}
                            <button onclick="deleteMessage('${reply.id}')" style="background: #ff4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; margin-left: 10px; font-size: 12px; cursor: pointer;">åˆ é™¤</button>
                            ${'{% endif %}'}
                        </div>
                    </div>
                `;
                
                container.appendChild(replyElement);
            });
        })
        .catch(error => {
            console.error('Error loading replies:', error);
        });
    }
    
    // åˆ‡æ¢æŠ˜å çŠ¶æ€
    function toggleFold(messageId) {
        fetch('/toggle_fold', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message_id: messageId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    
    // åˆ é™¤ç•™è¨€ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
    function deleteMessage(messageId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) return;
        
        fetch('/admin/delete_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message_id: messageId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåï¼Œä¸ºæ‰€æœ‰æœ‰å›å¤çš„ç•™è¨€åŠ è½½å›å¤
    document.addEventListener('DOMContentLoaded', function() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥æ£€æµ‹å“ªäº›ç•™è¨€æœ‰å›å¤å¹¶åŠ è½½å®ƒä»¬
        // ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œæˆ‘ä»¬åªåœ¨ç”¨æˆ·ç‚¹å‡»å›å¤æ—¶åŠ è½½
    });
</script>
{% endblock %}