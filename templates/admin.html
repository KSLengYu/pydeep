{% extends "base.html" %}

{% block title %}ç®¡ç†åå° - ç§‘å¹»ç•™è¨€æ¿{% endblock %}

{% block content %}
<div class="content">
    <div class="main-content">
        <h2 style="color: var(--primary); margin-bottom: 20px;">ğŸ›¡ï¸ ç®¡ç†åå°</h2>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: rgba(0,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--primary);">
                <h3 style="color: var(--primary); margin-bottom: 10px;">ç”¨æˆ·æ€»æ•°</h3>
                <p style="font-size: 2rem; font-weight: bold; color: var(--text);">{{ users|length }}</p>
            </div>
            <div style="background: rgba(255,0,255,0.2); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--secondary);">
                <h3 style="color: var(--secondary); margin-bottom: 10px;">ç•™è¨€æ€»æ•°</h3>
                <p style="font-size: 2rem; font-weight: bold; color: var(--text);">{{ messages|length }}</p>
            </div>
            <div style="background: rgba(0,255,0,0.2); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--accent);">
                <h3 style="color: var(--accent); margin-bottom: 10px;">å°ç¦ç”¨æˆ·</h3>
                <p style="font-size: 2rem; font-weight: bold; color: var(--text);">{{ bans|length }}</p>
            </div>
        </div>

        <!-- ç”¨æˆ·ç®¡ç† -->
        <div class="admin-section" style="margin-bottom: 30px;">
            <h3 style="color: var(--primary); margin-bottom: 15px;">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: rgba(0,255,255,0.3);">
                            <th style="padding: 12px; text-align: left;">é‚®ç®±</th>
                            <th style="padding: 12px; text-align: left;">QQæ˜µç§°</th>
                            <th style="padding: 12px; text-align: left;">è§’è‰²</th>
                            <th style="padding: 12px; text-align: left;">æ³¨å†Œæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 12px;">{{ user.email }}</td>
                            <td style="padding: 12px;">{{ user.qq_nickname or 'æœªç»‘å®š' }}</td>
                            <td style="padding: 12px;">
                                {% if user.role == 'super_admin' %}
                                    <span style="color: #ff9900;">è¶…çº§ç®¡ç†å‘˜</span>
                                {% elif user.role == 'admin' %}
                                    <span style="color: #0095ff;">ç®¡ç†å‘˜</span>
                                {% else %}
                                    <span style="color: var(--light);">æ™®é€šç”¨æˆ·</span>
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">{{ user.created_at[:16].replace('T', ' ') }}</td>
                            <td style="padding: 12px;">
                                {% if user.role != 'super_admin' and session.user_role == 'super_admin' %}
                                <select onchange="updateRole('{{ user.id }}', this.value)" style="background: rgba(0,0,0,0.5); color: var(--text); border: 1px solid var(--primary); border-radius: 3px; padding: 5px; margin-right: 10px;">
                                    <option value="user" {% if user.role == 'user' %}selected{% endif %}>æ™®é€šç”¨æˆ·</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>ç®¡ç†å‘˜</option>
                                </select>
                                {% endif %}
                                <button onclick="banUser('{{ user.id }}')" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer;">å°ç¦</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç•™è¨€ç®¡ç† -->
        <div class="admin-section" style="margin-bottom: 30px;">
            <h3 style="color: var(--primary); margin-bottom: 15px;">ğŸ’¬ ç•™è¨€ç®¡ç†</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: rgba(255,0,255,0.3);">
                            <th style="padding: 12px; text-align: left;">å†…å®¹</th>
                            <th style="padding: 12px; text-align: left;">ç”¨æˆ·</th>
                            <th style="padding: 12px; text-align: left;">ä½ç½®/è®¾å¤‡</th>
                            <th style="padding: 12px; text-align: left;">æ—¶é—´</th>
                            <th style="padding: 12px; text-align: left;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for message in messages %}
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 12px; max-width: 300px;">
                                <div style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                    {{ message.content }}
                                </div>
                            </td>
                            <td style="padding: 12px;">
                                {% if message.users %}
                                    {{ message.users.email }}
                                {% else %}
                                    æ¸¸å®¢
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">
                                <div style="font-size: 12px;">
                                    <div>{{ message.location }}</div>
                                    <div>{{ message.device_info }}</div>
                                </div>
                            </td>
                            <td style="padding: 12px;">{{ message.created_at[:16].replace('T', ' ') }}</td>
                            <td style="padding: 12px;">
                                <button onclick="deleteMessage('{{ message.id }}')" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer;">åˆ é™¤</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å°ç¦è®°å½• -->
        <div class="admin-section">
            <h3 style="color: var(--primary); margin-bottom: 15px;">ğŸš« å°ç¦è®°å½•</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: rgba(255,0,0,0.3);">
                            <th style="padding: 12px; text-align: left;">ç”¨æˆ·</th>
                            <th style="padding: 12px; text-align: left;">å°ç¦äºº</th>
                            <th style="padding: 12px; text-align: left;">åŸå› </th>
                            <th style="padding: 12px; text-align: left;">åˆ°æœŸæ—¶é—´</th>
                            <th style="padding: 12px; text-align: left;">å°ç¦æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ban in bans %}
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 12px;">
                                {% if ban.users %}
                                    {{ ban.users.email }}
                                {% else %}
                                    ç”¨æˆ·å·²åˆ é™¤
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">
                                {% if ban.users_bans_banned_by_fkey %}
                                    {{ ban.users_bans_banned_by_fkey.email }}
                                {% else %}
                                    ç³»ç»Ÿ
                                {% endif %}
                            </td>
                            <td style="padding: 12px;">{{ ban.reason or 'æœªè¯´æ˜åŸå› ' }}</td>
                            <td style="padding: 12px;">{{ ban.expires_at[:16].replace('T', ' ') }}</td>
                            <td style="padding: 12px;">{{ ban.created_at[:16].replace('T', ' ') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="color: var(--secondary); margin-bottom: 15px;">âš™ï¸ ç®¡ç†å·¥å…·</h3>
        
        <!-- å¿«é€Ÿå°ç¦ -->
        <div style="background: rgba(255,0,0,0.2); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ff4444;">
            <h4 style="color: #ff4444; margin-bottom: 10px;">å¿«é€Ÿå°ç¦ç”¨æˆ·</h4>
            <form id="quickBanForm">
                <div class="form-group">
                    <select id="banUserSelect" class="form-control" required>
                        <option value="">é€‰æ‹©ç”¨æˆ·</option>
                        {% for user in users %}
                            {% if user.role != 'super_admin' %}
                            <option value="{{ user.id }}">{{ user.email }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" id="banReason" class="form-control" placeholder="å°ç¦åŸå› " required>
                </div>
                <div class="form-group">
                    <select id="banDays" class="form-control" required>
                        <option value="1">1å¤©</option>
                        <option value="3">3å¤©</option>
                        <option value="7" selected>7å¤©</option>
                        <option value="30">30å¤©</option>
                        <option value="365">æ°¸ä¹…</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="background: #ff4444; width: 100%;">æ‰§è¡Œå°ç¦</button>
            </form>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div style="background: rgba(0,255,255,0.2); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--primary);">
            <h4 style="color: var(--primary); margin-bottom: 10px;">ç³»ç»Ÿä¿¡æ¯</h4>
            <div style="color: var(--light); font-size: 14px;">
                <p>å½“å‰è§’è‰²: 
                    {% if session.user_role == 'super_admin' %}
                    <span style="color: #ff9900;">è¶…çº§ç®¡ç†å‘˜</span>
                    {% else %}
                    <span style="color: #0095ff;">ç®¡ç†å‘˜</span>
                    {% endif %}
                </p>
                <p>ç™»å½•é‚®ç®±: {{ session.user_email }}</p>
                <p>å½“å‰æ—¶é—´: <span id="currentTime"></span></p>
            </div>
        </div>

        <!-- ç®¡ç†è¯´æ˜ -->
        <div style="background: rgba(0,255,0,0.2); padding: 20px; border-radius: 8px; border: 1px solid var(--accent);">
            <h4 style="color: var(--accent); margin-bottom: 10px;">ç®¡ç†è¯´æ˜</h4>
            <ul style="color: var(--light); font-size: 14px; padding-left: 20px;">
                <li>è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¾ç½®å…¶ä»–ç®¡ç†å‘˜</li>
                <li>ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç•™è¨€å’Œå°ç¦ç”¨æˆ·</li>
                <li>å°ç¦æ“ä½œè¯·è°¨æ…ä½¿ç”¨</li>
                <li>æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æ›´æ–°ç”¨æˆ·è§’è‰²
    function updateRole(userId, newRole) {
        if (!confirm(`ç¡®å®šè¦å°†ç”¨æˆ·è§’è‰²ä¿®æ”¹ä¸º ${newRole} å—ï¼Ÿ`)) {
            return;
        }

        fetch('/admin/update_role', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                user_id: userId,
                role: newRole
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // åˆ é™¤ç•™è¨€
    function deleteMessage(messageId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
        }

        fetch('/admin/delete_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message_id: messageId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // å°ç¦ç”¨æˆ·
    function banUser(userId) {
        const reason = prompt('è¯·è¾“å…¥å°ç¦åŸå› :');
        if (reason === null) return;
        
        const days = prompt('è¯·è¾“å…¥å°ç¦å¤©æ•° (é»˜è®¤7å¤©):', '7');
        if (days === null) return;

        fetch('/admin/ban_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                user_id: userId,
                reason: reason,
                days: parseInt(days) || 7
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('å°ç¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    }

    // å¿«é€Ÿå°ç¦è¡¨å•
    document.getElementById('quickBanForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userId = document.getElementById('banUserSelect').value;
        const reason = document.getElementById('banReason').value;
        const days = document.getElementById('banDays').value;

        if (!userId) {
            showAlert('è¯·é€‰æ‹©è¦å°ç¦çš„ç”¨æˆ·', 'error');
            return;
        }

        if (!confirm(`ç¡®å®šè¦å°ç¦è¯¥ç”¨æˆ· ${days} å¤©å—ï¼Ÿ`)) {
            return;
        }

        fetch('/admin/ban_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                user_id: userId,
                reason: reason,
                days: parseInt(days)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                document.getElementById('quickBanForm').reset();
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('å°ç¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
    });

    // æ›´æ–°å½“å‰æ—¶é—´
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
    });
</script>
{% endblock %}